<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="10">
    <title>Radio-MD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
         /* ... existing styles ... */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Circle of Fifths Soft Tailwind Color Classes */
        .key-c { color: #f472b6; } /* Pink - C */
        .key-g { color: #f87171; } /* Red - G */
        .key-d { color: #fb923c; } /* Orange - D */
        .key-a { color: #fcd34d; } /* Yellow - A */
        .key-e { color: #a3e635; } /* Lime - E */
        .key-b { color: #4ade80; } /* Green - B */
        .key-fs { color: #2dd4bf; } /* Teal - F# */
        .key-cs { color: #22d3ee; } /* Cyan - C# */
        .key-gs { color: #38bdf8; } /* Light Blue - G# */
        .key-ds { color: #818cf8; } /* Indigo - D# */
        .key-as { color: #c084fc; } /* Purple - A# */
        .key-f { color: #e879f9; } /* Fuchsia - F */

        /* Minor keys (darker versions) */
        .key-am { color: #ec4899; } /* Dark Pink - Am */
        .key-em { color: #ef4444; } /* Dark Red - Em */
        .key-bm { color: #f97316; } /* Dark Orange - Bm */
        .key-fsm { color: #f59e0b; } /* Dark Yellow - F#m */
        .key-csm { color: #84cc16; } /* Dark Lime - C#m */
        .key-gsm { color: #22c55e; } /* Dark Green - G#m */
        .key-dsm { color: #14b8a6; } /* Dark Teal - D#m */
        .key-asm { color: #06b6d4; } /* Dark Cyan - A#m */
        .key-fm { color: #0ea5e9; } /* Dark Light Blue - Fm */
        .key-cm { color: #6366f1; } /* Dark Indigo - Cm */
        .key-gm { color: #a855f7; } /* Dark Purple - Gm */
        .key-dm { color: #d946ef; } /* Dark Fuchsia - Dm */

        /* Default/Unknown key */
        .key-unknown { color: #94a3b8; } /* Slate - Unknown */
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

<div class="max-w-6xl mx-auto">
    <header class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 rounded-lg">
            Radio-MD
        </h1>
        <p class="mt-2 text-gray-400">Your curated collection of generated music narratives.</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">


        <div class="lg:col-span-1 space-y-6">
            <div class="bg-gray-800 rounded-xl p-6 shadow-xl sticky top-8">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Now Playing</h2>
                <div id="now-playing-info" class="text-gray-400 text-center">
                    {% if currently_playing %}
                    <i id="now-playing-disc" class="fa-solid fa-compact-disc fa-spin text-5xl mb-4"></i>
                    <p>Playing the key of {{ currently_playing_key }}</p>
                    {% else %}
                    <button onclick="playRadio()"><i class="fa-solid fa-play text-5xl mb-4 text-purple-400"></i>
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Recent History</h2>
                <div class="h-[30rem] overflow-y-scroll hide-scrollbar">
                    <div id="current-history-list" class="space-y-2">
                        {% for key, song in current_history.items()|reverse %}
                        <div class="flex items-center justify-between p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-gray-700 bg-gray-700"
                             onclick="selectSong('{{ key }}')">
                            <div class="flex items-center space-x-4 flex-grow min-w-0">
                                <i class="fa-solid fa-music text-5xl" data-key="{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}"></i>
                                <span class="flex-grow text-sm sm:text-base truncate">{{ key.split('-')[0] }}</span>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <span class="text-xs text-gray-400 whitespace-nowrap">{{ song.played }} plays</span>
                                <i class="fa-solid fa-heart {% if song.liked %}text-red-500{% else %}text-gray-500{% endif %}"
                                   onclick="like('{{ key }}')"></i>
                                <i class="fa-solid fa-thumbs-down {% if song.disliked %}text-blue-500{% else %}text-gray-500{% endif %}"
                                   onclick="dislike('{{ key }}')"></i>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="history-section" class="lg:col-span-2 bg-gray-800 rounded-xl p-6 shadow-xl h-full">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Saved Tracks</h2>
            <div class="h-[40rem] overflow-y-scroll hide-scrollbar">
                <div id="history-list" class="space-y-2">
                    {% for key, song in history.items() %}
                    <div class="flex items-center justify-between p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-gray-700 bg-gray-700"
                         onclick="selectSong('{{ key }}')">
                        <div class="flex items-center space-x-4 flex-grow min-w-0">
                            <i class="fa-solid fa-music text-5xl" data-key="{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}"></i>
                            <span class="flex-grow text-sm sm:text-base truncate">{{ key }}</span>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <span class="text-xs text-gray-400 whitespace-nowrap">{{ song.played }} plays</span>
                            <i class="fa-solid fa-heart {% if song.liked %}text-red-500{% else %}text-gray-500{% endif %}"></i>
                            <i class="fa-solid fa-thumbs-down {% if song.disliked %}text-blue-500{% else %}text-gray-500{% endif %}"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
            <div id="song-details" class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Song Details</h2>
                <div id="selected-song-info" class="text-gray-400">
                    <div class="text-center mb-6">
                        <i id="detail-music-icon" class="fa-solid fa-music text-5xl mb-4" data-key="Unknown"></i>
                        <h3 id="song-title" class="text-xl font-bold text-white mb-2">Pick a song</h3>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Plays:</span>
                            <span id="song-plays" class="text-white font-semibold">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Liked:</span>
                            <i id="song-liked" class="fa-solid fa-heart text-gray-500 cursor-pointer"
                               onclick="like(selectedSongKey)"></i>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Disliked:</span>
                            <i id="song-disliked" class="fa-solid fa-thumbs-down text-gray-500 cursor-pointer"
                               onclick="dislike(selectedSongKey)"></i>
                        </div>
                    </div>
                    <button id="replay-button" onclick="replaySong()"
                            class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-play mr-2"></i>Replay Song
                    </button>
                </div>
            </div>

            </div>

    </main>
</div>
</body>
<script>
    let selectedSongKey = null;
    const historyData = {
        {% for key, song in history.items() %}
        "{{ key }}": {
            played: {{ song.played }},
            liked: {{ song.liked|lower }},
            disliked: {{ song.disliked|lower }},
            key: "{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}",
        },
        {% endfor %}

        {% for key, song in current_history.items() %}
        "{{ key }}": {
            played: {{ song.played }},
            liked: {{ song.liked|lower }},
            disliked: {{ song.disliked|lower }},
            key: "{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}",
        },
        {% endfor %}
    };

    // Circle of Fifths color mapping - Based on your Keys class
    const keyColorMap = {
        // Major keys from your Keys class
        'C': 'key-c', 'CMajor': 'key-c',
        'G': 'key-g', 'GMajor': 'key-g',
        'D': 'key-d', 'DMajor': 'key-d',
        'A': 'key-a', 'AMajor': 'key-a',
        'E': 'key-e', 'EMajor': 'key-e',
        'F': 'key-f', 'FMajor': 'key-f',

        // Minor keys from your Keys class
        'Am': 'key-am', 'AMinor': 'key-am', 'A_minor': 'key-am',
        'Em': 'key-em', 'EMinor': 'key-em', 'E_minor': 'key-em',
        'Bm': 'key-bm', 'BMinor': 'key-bm', 'B_minor': 'key-bm',
        'F#m': 'key-fsm', 'FSharpMinor': 'key-fsm', 'FSharp_minor': 'key-fsm',
        'C#m': 'key-csm', 'CSharpMinor': 'key-csm', 'CSharp_minor': 'key-csm',
        'Gm': 'key-gm', 'GMinor': 'key-gm', 'G_minor': 'key-gm',
        'Fm': 'key-fm', 'FMinor': 'key-fm', 'F_minor': 'key-fm',

        // Alternative notations
        'C major': 'key-c', 'G major': 'key-g', 'D major': 'key-d',
        'A major': 'key-a', 'E major': 'key-e', 'F major': 'key-f',
        'A minor': 'key-am', 'E minor': 'key-em', 'B minor': 'key-bm',
        'F# minor': 'key-fsm', 'C# minor': 'key-csm',
        'G minor': 'key-gm', 'F minor': 'key-fm',

        // Default
        'Unknown': 'key-unknown'
    };

    function getKeyColorClass(key) {
        // Normalize the key string
        const normalizedKey = key.trim();
        return keyColorMap[normalizedKey] || 'key-unknown';
    }

    function applyKeyColors() {
        // Apply colors to all music icons
        const musicIcons = document.querySelectorAll('i[data-key]');
        musicIcons.forEach(icon => {
            const key = icon.getAttribute('data-key');
            const colorClass = getKeyColorClass(key);

            // Remove any existing key color classes
            icon.className = icon.className.replace(/key-\w+/g, '');
            // Add the new color class
            icon.classList.add(colorClass);
        });

        // Apply color to the now playing disc if it exists
        const nowPlayingDisc = document.getElementById('now-playing-disc');
        if (nowPlayingDisc) {
            const currentlyPlayingKey = '{{ currently_playing_key }}';
            if (currentlyPlayingKey && currentlyPlayingKey !== '') {
                const colorClass = getKeyColorClass(currentlyPlayingKey);
                nowPlayingDisc.className = nowPlayingDisc.className.replace(/key-\w+/g, '');
                nowPlayingDisc.classList.add(colorClass);
            }
        }
    }

    function selectSong(key) {
        selectedSongKey = key;
        const song = historyData[key];

        // Update song details
        document.getElementById('song-title').textContent = "Key: " + song.key;
        document.getElementById('song-plays').textContent = song.played;
        document.getElementById('song-liked').className = song.liked ? 'fa-solid fa-heart text-red-500 cursor-pointer' : 'fa-solid fa-heart text-gray-500 cursor-pointer';
        document.getElementById('song-disliked').className = song.disliked ? 'fa-solid fa-thumbs-down text-blue-500 cursor-pointer' : 'fa-solid fa-thumbs-down text-gray-500 cursor-pointer';

        // Update the detail music icon with the correct key and color
        const detailIcon = document.getElementById('detail-music-icon');
        detailIcon.setAttribute('data-key', song.key);
        const colorClass = getKeyColorClass(song.key);
        detailIcon.className = 'fa-solid fa-music text-5xl mb-4 ' + colorClass;

        // Show song details panel
        document.getElementById('song-details').classList.remove('hidden');
    }

    async function replaySong() {
        if (!selectedSongKey) return;

        const song = historyData[selectedSongKey];

        try {
            const response = await fetch('/replay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: selectedSongKey, song_key: song['key'] })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Replaying song");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            // location.reload();
        }
    }

    async function playRadio() {
        try {
            const response = await fetch('/play', {
                method: 'GET'
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }
    async function like(signatureKey) {
        try {
            const response = await fetch('/like', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: signatureKey })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }
    async function dislike(signatureKey) {
        try {
            const response = await fetch('/dislike', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: signatureKey })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }

    // Apply colors when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        applyKeyColors();
    });
</script>
</html>