<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio-MD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ... existing styles ... */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Circle of Fifths Soft Tailwind Color Classes */
        .key-c { background-color: #f472b6; } /* Pink - C */
        .key-g { background-color: #f87171; } /* Red - G */
        .key-d { background-color: #fb923c; } /* Orange - D */
        .key-a { background-color: #fcd34d; } /* Yellow - A */
        .key-e { background-color: #a3e635; } /* Lime - E */
        .key-b { background-color: #4ade80; } /* Green - B */
        .key-fs { background-color: #2dd4bf; } /* Teal - F# */
        .key-cs { background-color: #22d3ee; } /* Cyan - C# */
        .key-gs { background-color: #38bdf8; } /* Light Blue - G# */
        .key-ds { background-color: #818cf8; } /* Indigo - D# */
        .key-as { background-color: #c084fc; } /* Purple - A# */
        .key-f { background-color: #e879f9; } /* Fuchsia - F */

        /* Minor keys (darker versions) */
        .key-am { background-color: #ec4899; } /* Dark Pink - Am */
        .key-em { background-color: #ef4444; } /* Dark Red - Em */
        .key-bm { background-color: #f97316; } /* Dark Orange - Bm */
        .key-fsm { background-color: #f59e0b; } /* Dark Yellow - F#m */
        .key-csm { background-color: #84cc16; } /* Dark C#m */
        .key-gsm { background-color: #22c55e; } /* Dark G#m */
        .key-dsm { background-color: #14b8a6; } /* Dark D#m */
        .key-asm { background-color: #06b6d4; } /* Dark A#m */
        .key-fm { background-color: #0ea5e9; } /* Dark Fm */
        .key-cm { background-color: #6366f1; } /* Dark Cm */
        .key-gm { background-color: #a855f7; } /* Dark Gm */
        .key-dm { background-color: #d946ef; } /* Dark Dm */

        /* Default/Unknown key */
        .key-unknown { background-color: #94a3b8; } /* Slate - Unknown */
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

<div class="max-w-6xl mx-auto">
    <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-gray-800 rounded-xl p-6 shadow-xl sticky top-8">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Now Playing</h2>
                <div id="now-playing-info" class="text-gray-400 text-center">
                    {% if currently_playing %}
                    <i id="now-playing-disc" class="fa-solid fa-compact-disc text-purple-400 fa-spin text-5xl mb-4"></i>
                        {% if player_name == 'Replayer' %}
                            <p>Replaying: {{ currently_playing_key }}</p>
                        {% else %}
                            <p>Playing: {{ currently_playing_key }}</p>
                        {% endif %}
                    {% else %}
                    <button onclick="playRadio()"><i class="fa-solid fa-play text-5xl mb-4 text-purple-400"></i>
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Recent History</h2>
                <div class="h-[30rem] overflow-y-scroll hide-scrollbar">
                    <div id="current-history-list" class="space-y-2">
                        {% if current_history %}
                            {% for key, song in current_history.items()|reverse %}
                            <div class="flex items-center justify-between p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-gray-700 bg-gray-700"
                                 onclick="selectSong('{{ key }}')">
                                <div class="flex items-center space-x-4 flex-grow min-w-0">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center album-cover" data-key="{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}">
                                        <i class="fa-solid fa-music text-xl text-white"></i>
                                    </div>
                                    <span class="flex-grow text-sm sm:text-base truncate">{{ key.split('-')[0] }}</span>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <span class="text-xs text-gray-400 whitespace-nowrap">{{ song.played }} plays</span>
                                    <i class="fa-solid fa-heart {% if song.liked %}text-red-500{% else %}text-gray-500{% endif %}"
                                       onclick="like('{{ key }}')"></i>
                                    <i class="fa-solid fa-thumbs-down {% if song.disliked %}text-blue-500{% else %}text-gray-500{% endif %}"
                                       onclick="dislike('{{ key }}')"></i>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
            <div id="song-details" class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">Song Details</h2>
                <div id="selected-song-info" class="text-gray-400">
                    <div class="text-center mb-6">
                        <div id="detail-album-cover" class="w-24 h-24 mx-auto mb-4 rounded-lg shadow-xl flex items-center justify-center">
                            <i id="detail-music-icon" class="fa-solid fa-music text-5xl text-white"></i>
                        </div>
                        <h3 id="song-title" class="text-xl font-bold text-white mb-2">Pick a song</h3>
                    </div>
                    <div class="mt-4 mb-6">
                        <h4 class="text-sm font-semibold text-white mb-2">Signature</h4>
                        <div id="signature-visualizer" class="flex flex-wrap gap-1">
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Plays:</span>
                            <span id="song-plays" class="text-white font-semibold">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Liked:</span>
                            <i id="song-liked" class="fa-solid fa-heart text-gray-500 cursor-pointer"
                               onclick="like(selectedSongKey)"></i>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Disliked:</span>
                            <i id="song-disliked" class="fa-solid fa-thumbs-down text-gray-500 cursor-pointer"
                               onclick="dislike(selectedSongKey)"></i>
                        </div>
                    </div>
                    <button id="replay-button" onclick="replaySong()"
                            class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">
                        <i class="fa-solid fa-play mr-2"></i>Replay Song
                    </button>
                </div>
            </div>
               <div class="lg:col-span-1 space-y-6">
            <div id="radio-stats" class="bg-gray-800 rounded-xl p-6 shadow-xl">
                <h2 class="text-2xl font-bold text-gray-200 mb-4">{{ radio_stats.name }} Settings</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-400">BPM:</span>
                        <span id="radio-bpm" class="text-white font-semibold">{{ radio_stats.bpm if radio_stats else '-' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-400">Narratives:</span>
                        <span id="radio-narratives" class="text-white font-semibold">{{ radio_stats.narratives if radio_stats else '-' }} <span title="{{ radio_stats.narratives }} Repeating {{ radio_stats.repeat }} times">({{ radio_stats.repeat }})</span></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-400">Keys:</span>
                        <span id="radio-keys" class="text-white font-semibold">{{ radio_stats.musical_keys if radio_stats else '-' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-400">Drums:</span>
                        {% if radio_stats %}
                        <span id="radio-drums" class="text-white font-semibold">{{ 'Enabled' if radio_stats.drums else '-' }}</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-400">Status:</span>
                        <span id="radio-status" class="text-white font-semibold">
                            {% if radio_stats %}
                                {% if radio_stats.playing %}
                                    <span class="text-green-400">
                                        <i class="fa-solid fa-play mr-1"></i>Playing
                                    </span>
                                {% elif radio_stats.pause %}
                                    <span class="text-yellow-400">
                                        <i class="fa-solid fa-pause mr-1"></i>Paused
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">
                                        <i class="fa-solid fa-stop mr-1"></i>Stopped
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">
                                    <i class="fa-solid fa-stop mr-1"></i>Stopped
                                </span>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        </div>


        <div id="history-section" class="lg:col-span-1 bg-gray-800 rounded-xl p-6 shadow-xl h-full">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">History</h2>
            <div class="h-[40rem] overflow-y-scroll hide-scrollbar">
                <div id="history-list" class="space-y-2">
                    {% if history %}
                        {% for key, song in history.items() %}
                        <div class="flex items-center justify-between p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-gray-700 bg-gray-700"
                             onclick="selectSong('{{ key }}')">
                            <div class="flex items-center space-x-4 flex-grow min-w-0">
                                <div class="w-12 h-12 rounded-lg flex items-center justify-center album-cover" data-key="{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}">
                                    <i class="fa-solid fa-music text-xl text-white"></i>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <span class="text-xs text-gray-400 whitespace-nowrap">{{ song.played }} plays</span>
                                <i class="fa-solid fa-heart {% if song.liked %}text-red-500{% else %}text-gray-500{% endif %}"></i>
                                <i class="fa-solid fa-thumbs-down {% if song.disliked %}text-blue-500{% else %}text-gray-500{% endif %}"></i>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
    <footer class="text-center">
        <pre class="mt-2 text-gray-400"><a href="/">radio-md</a> by <a href="https://github.com/gabru-md" target="_blank">gabru-md</a></pre>
    </footer>
</div>
</body>
<script>
    let selectedSongKey = null;
    const historyData = {
    {% for key, song in history.items() %}
    "{{ key }}": {
        played: {{ song.played }},
        liked: {{ song.liked|lower }},
        disliked: {{ song.disliked|lower }},
        key: "{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}",
    },
    {% endfor %}

    {% for key, song in current_history.items() %}
    "{{ key }}": {
        played: {{ song.played }},
        liked: {{ song.liked|lower }},
        disliked: {{ song.disliked|lower }},
        key: "{% if song.key %}{{ song.key }}{% else %}Unknown{% endif %}",
    },
    {% endfor %}
    };

    // Circle of Fifths color mapping - Based on your Keys class
    // Circle of Fifths color mapping - Based on your Keys class
    const keyColorMap = {
        // Major keys from your Keys class
        'C': 'key-c', 'CMajor': 'key-c',
        'G': 'key-g', 'GMajor': 'key-g',
        'D': 'key-d', 'DMajor': 'key-d',
        'A': 'key-a', 'AMajor': 'key-a',
        'E': 'key-e', 'EMajor': 'key-e',
        'B': 'key-b', 'BMajor': 'key-b',
        'F#': 'key-fs', 'FSharpMajor': 'key-fs',
        'C#': 'key-cs', 'CSharpMajor': 'key-cs',
        'G#': 'key-gs', 'GSharpMajor': 'key-gs',
        'D#': 'key-ds', 'DSharpMajor': 'key-ds',
        'A#': 'key-as', 'ASharpMajor': 'key-as',
        'F': 'key-f', 'FMajor': 'key-f',

        // Minor keys from your Keys class
        'Am': 'key-am', 'AMinor': 'key-am',
        'Em': 'key-em', 'EMinor': 'key-em',
        'Bm': 'key-bm', 'BMinor': 'key-bm',
        'F#m': 'key-fsm', 'FSharpMinor': 'key-fsm',
        'C#m': 'key-csm', 'CSharpMinor': 'key-csm',
        'G#m': 'key-gsm', 'GSharpMinor': 'key-gsm',
        'D#m': 'key-dsm', 'DSharpMinor': 'key-dsm',
        'A#m': 'key-asm', 'ASharpMinor': 'key-asm',
        'EFlatMajor': 'key-ds', 'BFlatMajor': 'key-as',
        'Fm': 'key-fm', 'FMinor': 'key-fm',
        'Cm': 'key-cm', 'CMinor': 'key-cm',
        'Gm': 'key-gm', 'GMinor': 'key-gm',
        'Dm': 'key-dm', 'DMinor': 'key-dm',

        // Alternative notations (for compatibility)
        'A_min': 'key-am', 'E_min': 'key-em', 'B_min': 'key-bm',
        'FSharp_min': 'key-fsm', 'CSharp_min': 'key-csm', 'GSharp_min': 'key-gsm',
        'D_min':'key-dm', 'D_maj': 'key-d', 'G_maj': 'key-g', 'A_maj': 'key-a',
        'F_maj': 'key-f',
        'E_maj': 'key-e', 'B_maj': 'key-b', 'FSharp_maj': 'key-fs', 'ASharp_min': 'key-asm',
        'CSharp_maj': 'key-cs',
        'EFlat_maj': 'key-ds', 'AFlat_maj': 'key-gs', 'BFlat_maj': 'key-as', 'DFlat_maj': 'key-cs',
        'ADim': 'key-csm', 'GSharp_maj': 'key-gs',
        'G_min': 'key-gm', 'F_min': 'key-fm', 'BFlat_min': 'key-asm',
        'C_min':'key-cm', 'C_maj': 'key-c',
        'DSharp_min': 'key-dsm',
        'DFlat_min': 'key-csm',
        // Default
        'Unknown': 'key-unknown'
    };

    function getKeyColorClass(key) {
        // Normalize the key string
        const normalizedKey = key.trim();
        return keyColorMap[normalizedKey] || 'key-unknown';
    }

    function applyKeyColors() {
        // Apply colors to all album cover divs in the history lists
        const albumCovers = document.querySelectorAll('.album-cover');
        albumCovers.forEach(cover => {
            const key = cover.getAttribute('data-key');
            const colorClass = getKeyColorClass(key);

            // Remove any existing key color classes
            cover.className = cover.className.replace(/key-\w+/g, '');
            // Add the new color class
            cover.classList.add(colorClass);
        });
    }

    function selectSong(key) {
        selectedSongKey = key;
        const song = historyData[key];

        console.log(song);

        // Update song details
        document.getElementById('song-title').textContent = "Key: " + song.key;
        document.getElementById('song-plays').textContent = song.played;
        document.getElementById('song-liked').className = song.liked ? 'fa-solid fa-heart text-red-500 cursor-pointer' : 'fa-solid fa-heart text-gray-500 cursor-pointer';
        document.getElementById('song-disliked').className = song.disliked ? 'fa-solid fa-thumbs-down text-blue-500 cursor-pointer' : 'fa-solid fa-thumbs-down text-gray-500 cursor-pointer';

        // Update the album cover and music icon
        const albumCover = document.getElementById('detail-album-cover');
        const colorClass = getKeyColorClass(song.key);
        // Remove existing background color classes
        albumCover.className = albumCover.className.replace(/key-\w+/g, '');
        // Add the new background color class
        albumCover.classList.add(colorClass);

        // *** New logic to render the signature visualization ***
        const visualizer = document.getElementById('signature-visualizer');
        visualizer.innerHTML = ''; // Clear existing visual

        if (song.key && song.key !== 'Unknown') {
            const bars = key.split('_^_');
            bars.forEach(barStr => {
                const parts = barStr.split(':');
                if (parts[0]) {
                    const firstChord = parts[0].split(',')[0].replace(/_chord|-.*$/, '').trim();
                    const barDiv = document.createElement('div');
                    const color = getKeyColorClass(firstChord);
                    barDiv.className = `w-4 h-4 rounded-sm ${color}`;
                    barDiv.title = firstChord;
                    visualizer.appendChild(barDiv);
                }
            });
        }

        // Show song details panel
        document.getElementById('song-details').classList.remove('hidden');
    }

    async function replaySong() {
        if (!selectedSongKey) return;

        const song = historyData[selectedSongKey];

        try {
            const response = await fetch('/replay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: selectedSongKey, song_key: song['key'] })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Replaying song");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            // location.reload();
        }
    }

    async function playRadio() {
        try {
            const response = await fetch('/play', {
                method: 'GET'
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }
    async function like(signatureKey) {
        try {
            const response = await fetch('/like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: signatureKey })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }
    async function dislike(signatureKey) {
        try {
            const response = await fetch('/dislike', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: signatureKey })
            });
            const result = await response.text();
            if(result === "Ok") {
                console.log("Done");
            }
        } catch (error) {
            console.error('Network or server error', error);
        } finally {
            location.reload();
        }
    }

    // Apply colors when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        applyKeyColors();
        addSignatureVisualizers();
        {% if currently_playing %}
        selectSong("{{ currently_playing }}")
        {% endif %}
    });

    function addSignatureVisualizers() {
        const historyItems = document.querySelectorAll('#current-history-list .p-4');
        historyItems.forEach(item => {
            const key = item.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (key) {
                const visualizerDiv = document.createElement('div');
                visualizerDiv.className = 'flex flex-wrap gap-1 flex-grow justify-end';

                const bars = key.split('_^_');
                bars.forEach(barStr => {
                    const parts = barStr.split(':');
                    if (parts[0]) {
                        const firstChord = parts[0].split(',')[0].replace(/_chord|-.*$/, '').trim();
                        const barDiv = document.createElement('div');
                        const color = getKeyColorClass(firstChord);
                        barDiv.className = `w-2 h-2 rounded-sm ${color}`;
                        barDiv.title = firstChord;
                        visualizerDiv.appendChild(barDiv);
                    }
                });

                // Find the existing play count and icons container and insert before it
                const iconContainer = item.querySelector('.space-x-2');
                if (iconContainer) {
                    item.insertBefore(visualizerDiv, iconContainer);
                }
            }
        });
    }

</script>
</html>